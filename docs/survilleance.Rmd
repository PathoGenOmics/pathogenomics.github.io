---
title: "Submissions in GISAID"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 2
    smooth_scroll: false
    #code_folding: hide
---
<style>
body {
text-align: justify}
</style>

The main objective of this report is to be able to quantify the upload of Spanish SARS-CoV-2 sequences in GISAID available to researchers. For good monitoring of the pandemic, the sequences should be uploaded as soon as possible when the sample is taken from the patient, but many times this is not the case, and we can have sequences uploaded today that infected a patient 2 years ago.

That is why we are going to download all the sequences of patients in Spain and we are going to analyze the metadata associated with these sequences, where we are going to focus on: upload date, sampling date, autonomous community location, lineage/variant of interest. 

All data is available to researchers through the GISAID platform.

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=FALSE)

library(GISAIDR)
library(ggplot2)
library(tidyverse)
library(scales)
library(knitr)
library(kableExtra)
library(plotrix)
library(formattable)
library(plotly)
library(reshape2)
library(mapSpain)
library(ggplot2)
library(viridis)
Sys.setlocale("LC_TIME", "English")
current_date <- as.character(Sys.Date())
days_7 <- as.character(Sys.Date()-6)
current_month <- format(Sys.Date(),"%Y-%m-01")

data <- read.csv("C:/Users/pauru/OneDrive - Universitat de Valencia (1)/paginaweb_pgo/codigo/generate_web/downloadedmetadata_2022-10-02.tsv",sep="\t", fileEncoding = "UTF-8", stringsAsFactors=FALSE)
table<-read.csv("codes.tsv",sep="\t", fileEncoding = "iso-8859-1", stringsAsFactors=FALSE)

for (row in 1:nrow(table)) {
    data$code[data$community ==  as.character(table[row, ][1] )]<-as.character(table[row, ][2] )
 }
```

```{r generate plot1, message=FALSE, warning=FALSE, include=FALSE}
data$date_submitted<-as.Date(data$date_submitted)
plot_dataset<- data %>%
  mutate(month = lubridate::floor_date(date_submitted, 'month')) %>%
  group_by(month,upload) %>%
  summarise(n = n())
plot_dataset<-na.omit(plot_dataset)
plot_dataset$upload <- factor(plot_dataset$upload, levels = c("> 2 months", "1-2 months", "<=1 month"))

plot_dataset$month<-as.Date(plot_dataset$month)

tb1<- plot_dataset  %>%
  group_by(upload) %>%
  summarise(number = sum(n))%>%
  mutate(freq = formattable::percent(number / sum(number))) %>% 
  arrange(desc(freq))

totaltb1<-sum(tb1$number)

data2 <- data[data$upload != "<=1 month", ]
data2$date_submitted<-as.Date(data2$date_submitted)
dataplot2<-data2 %>%
  mutate(month = lubridate::floor_date(date_submitted, 'month')) %>%
  group_by(community,code) %>%
  summarise(n = n())
```

# Spanish sequences uploaded in GISAID

All sequences uploaded from the beginning of the pandemic to the generation of this report are displayed here.

`r totaltb1` sequences from Spain available on  `r Sys.Date()`

To evaluate the delay in uploading sequences and hinder epidemiological surveillance, they have been classified according to the days of difference between the date of sample collection and the date of upload to the database. In this way they have been classified into 3 levels.

1.  [**1 month**]{style="color:#a056c5"}: The difference between the sampling date and the upload date is equal to or less than 1 month.
2.  [**1-2 months**]{style="color:#24a0c2"}: The difference between the sampling date and the upload date is greater than 1 month but less or equal (<=) than 2 months.
3.  [**\> 2 months**]{style="color:#fa8628"}: The difference between the sampling date and the upload date is greater than 2 months.

## Percentage of sequences by upload status
The number of sequences for the 3 levels from the beginning of the pandemic are shown below:

```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

colors <- c("#a056c5", "#24a0c2","#fa8628")

fig <- plot_ly(tb1, labels = ~upload, values = ~number, type = 'pie',
        textposition = 'inside',
        textfont = list(size = 18),
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        hoverinfo = 'text',
        text = ~paste( number, 'sequences'),
        marker = list(colors = colors,
                      line = list(color = '#FFFFFF', width = 1)), showlegend = TRUE)


fig %>%
  layout(legend = list(font = list(size = 18)),
         hoverlabel = list(font = list(size = 18)))
```

We observed that in the first months of the pandemic the delay in uploading sequences was notable and has been improving over the course. It is observed that in some months half of the uploaded sequences correspond to the past, only in January 2022 were all sequences uploaded with a difference of less than 1 month.

## Number of sequences uploaded by month
```{r echo=FALSE, message=FALSE, fig.height=5, fig.width=9.2, warning=FALSE, results='asis'}
a <- dcast(plot_dataset,month~upload)
fig <- plot_ly(a, x = ~month, y = ~`<=1 month`, type = 'bar', name = '<=1 months',marker = list(color = '#a056c5',
                           line = list(color ='rgb(8,48,107)', width = 1.5)))
fig <- fig %>% add_trace(y = ~`1-2 months`, name = '1-2 month',
            marker = list(color = '#24a0c2',
                          line = list(color = 'rgb(8,48,107)', width = 1.5)))
fig <- fig %>% add_trace(y = ~`> 2 months`, name = '>2 month',
            marker = list(color = '#fa8628',
                          line = list(color = 'rgb(8,48,107)', width = 1.5)))
fig <- fig %>% layout(yaxis = list(title = 'Count'), barmode = 'stack')
fig %>%
  layout(legend = list(font = list(size = 15)))
```

## Number of sequences by region
```{r echo=FALSE, fig.height=5, fig.width=9.2, message=FALSE, warning=FALSE, results='asis'}
plot_dataset3<- data %>% 
  group_by(community,upload) %>%
  summarise(n = n())
plot_dataset3<-na.omit(plot_dataset3)
plot_dataset3$upload <- factor(plot_dataset3$upload, levels = c("> 2 months", "1-2 months", "<=1 month"))

b <- dcast(plot_dataset3,community~upload)

fig <- plot_ly(b, x = ~community, y = ~`<=1 month`, type = 'bar', name = '<=1 months',marker = list(color = '#a056c5',
                           line = list(color = 'rgb(8,48,107)', width = 1.5)))
fig <- fig %>% add_trace(y = ~`1-2 months`, name = '1-2 month',
            marker = list(color = '#24a0c2',
                          line = list(color = 'rgb(8,48,107)', width = 1.5)))
fig <- fig %>% add_trace(y = ~`> 2 months`, name = '>2 month',
            marker = list(color = '#fa8628',
                          line = list(color = 'rgb(8,48,107)', width = 1.5)))
fig <- fig %>% layout(yaxis = list(title = 'Count'), barmode = 'stack')
dd<-fig %>%
  layout(legend = list(font = list(size = 15)))
dd
```

## Histogram by region
```{r echo=FALSE, fig.height=5, fig.width=9.2, message=FALSE, warning=FALSE, results='asis'}
data2<-na.omit(data.frame(data$community,data$upload))
plot_dataset4<- data2 %>% 
  group_by(data.community,data.upload) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n))

plot_dataset4$data.upload <- factor(plot_dataset4$data.upload, levels = c("> 2 months", "1-2 months", "<=1 month"))


b <- dcast(plot_dataset4,data.community~data.upload)

fig <- plot_ly(b, x = ~data.community, y = ~`<=1 month`, type = 'bar', name = '<=1 months',marker = list(color = '#a056c5',
                           line = list(color = 'rgb(8,48,107)', width = 1.5)))
fig <- fig %>% add_trace(y = ~`1-2 months`, name = '1-2 month',
            marker = list(color = '#24a0c2',
                          line = list(color = 'rgb(8,48,107)', width = 1.5)))
fig <- fig %>% add_trace(y = ~`> 2 months`, name = '>2 month',
            marker = list(color = '#fa8628',
                          line = list(color = 'rgb(8,48,107)', width = 1.5)))
fig <- fig %>% layout(yaxis = list(title = 'Frequency'), barmode = 'stack')
dd<-fig %>%
  layout(legend = list(font = list(size = 15)))
dd
```

# Spanish sequences uploaded with a delay greater than 1 month

```{r echo=FALSE, fig.height=5, fig.width=9.2, message=FALSE, warning=FALSE, results='asis'}
noplot_dataset4 <- plot_dataset4[plot_dataset4$data.upload != "<=1 month", ]

noplot_dataset4<-aggregate(noplot_dataset4$freq, by=list(community=noplot_dataset4$data.community), FUN=sum)

d3<-merge(noplot_dataset4, dataplot2, by.x = "community", by.y = "community")

fig <- plot_ly(d3, x = ~n, y = ~x, text = ~community, type = 'scatter', mode = 'markers', size = ~n, color = ~community, colors = 'Paired',
               #Choosing the range of the bubbles' sizes:
               sizes = c(10, 50),
               marker = list(opacity = 0.5, sizemode = 'diameter'))
fig
```



```{r echo=FALSE}
CCAA_sf <- esp_get_ccaa()
CCAA_sf$codauto<-as.numeric(CCAA_sf$codauto)

dataplot2 <- na.omit(dataplot2)

d2<-merge(dataplot2, CCAA_sf, by.x = "code", by.y = "codauto")
census <- mapSpain::pobmun19

# Extract CCAA from base dataset

codelist <- mapSpain::esp_codelist

census <-
  unique(merge(census, codelist[, c("cpro", "codauto")], all.x = TRUE))

# Summarize by CCAA
census_ccaa <-
  aggregate(cbind(pob19, men, women) ~ codauto, data = census, sum)

census_ccaa$porc_women <- census_ccaa$women / census_ccaa$pob19
census_ccaa$porc_women_lab <-
  paste0(round(100 * census_ccaa$porc_women, 2), "%")

# Merge into spatial data

CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, census_ccaa)
Can <- esp_get_can_box()


# Plot with ggplot


CCAA_sf = sf::st_cast(CCAA_sf, "MULTIPOLYGON")
                      CCAA_sf$codauto<-as.numeric(CCAA_sf$codauto)
CCAA_sf<-merge(CCAA_sf,dataplot2, by.y = "code", by.x = "codauto")
a<-ggplot(CCAA_sf) +
  geom_sf(aes(fill = n),
          color = "grey70",
          lwd = .3
  ) +
  geom_sf(data = Can, color = "grey70")+
  scale_fill_viridis()  +
  theme_minimal()
ggplotly(a) 

```

# Spanish sequences with no delay
```{r echo=FALSE, fig.height=5, fig.width=9.2, message=FALSE, warning=FALSE, results='asis'}
data2 <- data[data$upload == "<=1 month", ]
data2$date_submitted<-as.Date(data2$date_submitted)
dataplot2<-data2 %>%
  mutate(month = lubridate::floor_date(date_submitted, 'month')) %>%
  group_by(community,code) %>%
  summarise(n = n())

noplot_dataset4 <- plot_dataset4[plot_dataset4$data.upload == "<=1 month", ]

noplot_dataset4<-aggregate(noplot_dataset4$freq, by=list(community=noplot_dataset4$data.community), FUN=sum)

d3<-merge(noplot_dataset4, dataplot2, by.x = "community", by.y = "community")

fig <- plot_ly(d3, x = ~n, y = ~x, text = ~community, type = 'scatter', mode = 'markers', size = ~n, color = ~community, colors = 'Paired',
               #Choosing the range of the bubbles' sizes:
               sizes = c(10, 50),
               marker = list(opacity = 0.5, sizemode = 'diameter'))
fig
```


